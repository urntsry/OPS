# THERMOTECH-OPS 核心邏輯確認

## 🎯 任務分配系統核心邏輯

### 關鍵概念
**「匹配」（Assignment Matching）**

> 每個人只看到屬於自己的事項，不會看到別人的事項。

---

## 📊 資料關係

### 1. 人員列表（Profiles）
```
員工編號 | 姓名   | 部門   | 職稱
---------|--------|--------|--------
10003    | 張庭憲 | 廠務部 | 廠長
33333    | 測試員 | 廠務部 | 作業員
50168    | 李家榮 | 廠務部 | 出圖員
```

### 2. 事件項目列表（Task Definitions）
```
ID | 標題           | 類型   | 頻率
---|----------------|--------|------
1  | 週四丟垃圾     | 例行   | 每週四
2  | 每月6號匯款    | 例行   | 每月6日
3  | 每日巡檢機台   | 例行   | 每日
4  | 整理316文件    | 交辦   | 單次
```

### 3. 匹配關係（Task Assignments）
```
人員編號 | 事件ID | 說明
---------|--------|------------------
33333    | 1      | 測試員負責丟垃圾
33333    | 2      | 測試員負責匯款
33333    | 3      | 測試員負責巡檢
33333    | 4      | 測試員負責整理文件
---------|--------|------------------
10003    | 2      | 廠長負責匯款
10003    | 3      | 廠長負責巡檢
```

### 4. 公共事項（Public Events）
**所有人都能看到**
```
ID | 標題         | 日期
---|--------------|----------
1  | 垃圾車收運   | 11/22
2  | 公司尾牙     | 11/28
3  | 國定假日     | 12/25
```

---

## 🖥️ 使用者登入後的顯示邏輯

### 情境 A：員工編號 33333 登入

**他的行事曆會顯示**：
```
┌─────────────────────────────────────┐
│ 2025年11月                           │
│                                      │
│  四: 丟垃圾 (例行)                   │
│  6日: 匯款 (例行)                    │
│  每日: 巡檢機台 (例行)               │
│  25日: 整理316文件 (交辦)            │
│                                      │
│  22日: 垃圾車收運 (公共)             │
│  28日: 公司尾牙 (公共)               │
└─────────────────────────────────────┘
```

**他的例行公事列表**：
- [ ] 週四丟垃圾
- [ ] 每月6號匯款
- [ ] 每日巡檢機台

**他的交辦事項**：
- [ ] 整理316文件

**公共事項（所有人都看到）**：
- 垃圾車收運 (11/22)
- 公司尾牙 (11/28)

---

### 情境 B：員工編號 10003 登入

**他的行事曆會顯示**：
```
┌─────────────────────────────────────┐
│ 2025年11月                           │
│                                      │
│  6日: 匯款 (例行)                    │
│  每日: 巡檢機台 (例行)               │
│                                      │
│  22日: 垃圾車收運 (公共)             │
│  28日: 公司尾牙 (公共)               │
└─────────────────────────────────────┘
```

**他只看到自己被分配的 2 項例行公事**
**他看不到「丟垃圾」和「整理316文件」（因為沒有匹配給他）**

---

## ⚙️ 設定頁功能需求

### 核心功能
1. **顯示所有人員**
2. **顯示所有事件項目**
3. **建立匹配關係**（拖曳或勾選）
4. **編輯/刪除匹配**

### 設定頁設計概念

```
┌──────────────────────────────────────────────────────┐
│ 系統設定 - 任務分配管理                               │
├──────────────────────────────────────────────────────┤
│                                                        │
│ [人員列表]                    [事件項目列表]          │
│                                                        │
│ ┌────────────────┐            ┌──────────────────┐   │
│ │ 10003 張庭憲   │←─匹配─→│ 1. 週四丟垃圾     │   │
│ │ 33333 測試員   │←─匹配─→│ 2. 每月6號匯款    │   │
│ │ 50168 李家榮   │            │ 3. 每日巡檢機台   │   │
│ └────────────────┘            └──────────────────┘   │
│                                                        │
│ 選擇人員: [33333 測試員 ▼]                            │
│                                                        │
│ 已分配的任務:                                          │
│  [X] 週四丟垃圾                                        │
│  [X] 每月6號匯款                                       │
│  [X] 每日巡檢機台                                      │
│  [X] 整理316文件                                       │
│  [ ] （其他可選任務...）                               │
│                                                        │
│ [儲存變更]                                             │
└──────────────────────────────────────────────────────┘
```

---

## 🗄️ 資料庫設計更新

### 新增表：task_user_assignments
```sql
CREATE TABLE task_user_assignments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES profiles(id) NOT NULL,
  task_def_id BIGINT REFERENCES task_definitions(id) NOT NULL,
  assigned_by UUID REFERENCES profiles(id),      -- 誰分配的
  assigned_at TIMESTAMPTZ DEFAULT NOW(),
  is_active BOOLEAN DEFAULT TRUE,
  UNIQUE(user_id, task_def_id)                   -- 防止重複分配
);
```

### 查詢邏輯

#### 取得某人的例行公事
```sql
SELECT td.*
FROM task_definitions td
JOIN task_user_assignments tua ON td.id = tua.task_def_id
WHERE tua.user_id = '某人的UUID'
  AND tua.is_active = true
  AND td.event_type = 'routine';
```

#### 取得某人的交辦事項
```sql
SELECT td.*
FROM task_definitions td
JOIN task_user_assignments tua ON td.id = tua.task_def_id
WHERE tua.user_id = '某人的UUID'
  AND tua.is_active = true
  AND td.event_type = 'assignment';
```

#### 取得所有公共事項
```sql
SELECT * FROM public_events
WHERE is_active = true;
```

---

## ✅ 確認事項

### 您的需求
1. ✅ 設定頁可以看到所有人
2. ✅ 設定頁可以看到所有事件項目
3. ✅ 設定頁可以建立「匹配」
4. ✅ 每個人登入只看到自己被匹配的事項
5. ✅ 公共事項所有人都能看到

### 下一步開發
1. 建立「設定頁」UI
2. 實作「人員-任務匹配」介面
3. 整合 Supabase 資料庫
4. 實作登入後的個人化顯示

---

**立即開始開發設定頁！** 🚀


