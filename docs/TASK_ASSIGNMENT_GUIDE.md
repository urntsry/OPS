# ✅ 任務分配系統完整指南

## 🎯 核心概念

### "匹配制度"
> 每個人只看到自己被分配的任務，不會看到別人的任務。

---

## 📋 系統設定頁功能

### 訪問方式
1. 以 Admin 身份登入
2. 點擊頂部「設定」分頁
3. 進入「任務分配管理」介面

---

## 🖥️ 設定頁介面說明

### 畫面結構
```
┌──────────────────────────────────────────────────────┐
│ 系統設定 - 任務分配管理                               │
├──────────────────────────────────────────────────────┤
│                                                        │
│ ┌─ 人員列表 ─────────┐  ┌─ 事件項目列表 ────────┐  │
│ │編號  姓名  部門  任務數│  │ID  標題  類型  頻率    │  │
│ │10003 張庭憲 廠務  2  │  │1   週四丟垃圾 例行 每週四│  │
│ │33333 測試員 廠務  4  │  │2   每月6號匯款 例行 每月6│  │
│ │50168 李家榮 廠務  0  │  │3   每日巡檢機台 例行 每日│  │
│ └───────────────────────┘  └────────────────────────┘  │
│                                                        │
│ ┌─ 任務分配 - 測試員 (33333) ──────────────────┐     │
│ │                                                │     │
│ │ [X] 週四丟垃圾       每週四    例行           │     │
│ │ [X] 每月6號匯款      每月6日   例行           │     │
│ │ [X] 每日巡檢機台     每日       例行           │     │
│ │ [X] 整理316文件      單次       交辦           │     │
│ │ [ ] 協助主管報表     單次       交辦           │     │
│ │ [ ] 品質異常處理     每週       例行           │     │
│ │                                                │     │
│ │ [儲存變更] [取消]                              │     │
│ │                                                │     │
│ │ 目前已分配: 4 項任務                           │     │
│ │ 例行公事: 3 | 交辦事項: 1                      │     │
│ └────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────┘
```

---

## 🔧 操作步驟

### 步驟 1：選擇人員
在「人員列表」中點擊某人的「編輯」按鈕，該人員會被高亮顯示。

### 步驟 2：分配任務
在下方「任務分配」區域：
- 點擊 `[ ]` 勾選框來**分配**任務
- 點擊 `[X]` 勾選框來**取消**任務

### 步驟 3：查看統計
即時顯示：
- 已分配的總任務數
- 例行公事數量
- 交辦事項數量

### 步驟 4：儲存變更
點擊「儲存變更」按鈕，變更會立即生效。

---

## 🧑 使用者登入後的顯示

### 範例情境

#### 設定
- **測試員 (33333)** 被分配了 4 項任務：
  1. 週四丟垃圾
  2. 每月6號匯款
  3. 每日巡檢機台
  4. 整理316文件

#### 當測試員登入後

**首頁行事曆顯示**：
```
2025年11月
┌──┬──┬──┬──┬──┬──┬──┐
│一│二│三│四│五│六│日│
├──┼──┼──┼──┼──┼──┼──┤
│  │  │  │6 │  │  │  │
│  │  │  │丟│  │  │  │  ← 每週四顯示「丟垃圾」
│  │  │  │垃│  │  │  │
│  │  │  │圾│  │  │  │
│  │  │  │匯│  │  │  │  ← 6號顯示「匯款」
│  │  │  │款│  │  │  │
└──┴──┴──┴──┴──┴──┴──┘

每日顯示：巡檢機台
```

**例行公事列表**：
- [ ] 週四丟垃圾
- [ ] 每月6號匯款
- [ ] 每日巡檢機台

**交辦事項列表**：
- [ ] 整理316文件

**公共事項列表**（所有人都看到）：
- 垃圾車收運 (11/22)
- 公司尾牙 (11/28)

---

## 🔐 權限說明

### Admin
- ✅ 可以看到所有人員
- ✅ 可以看到所有任務項目
- ✅ 可以為任何人分配/取消任務
- ✅ 可以訪問設定頁

### 一般同事
- ✅ 只能看到自己被分配的任務
- ❌ 看不到其他人的任務
- ❌ 無法訪問設定頁
- ✅ 可以完成自己的任務

---

## 📊 資料庫設計

### task_user_assignments 表
```sql
CREATE TABLE task_user_assignments (
  id BIGINT PRIMARY KEY,
  user_id UUID,              -- 被分配的人員
  task_def_id BIGINT,        -- 任務項目ID
  assigned_by UUID,          -- 誰分配的（Admin）
  assigned_at TIMESTAMPTZ,   -- 分配時間
  is_active BOOLEAN,         -- 是否啟用
  UNIQUE(user_id, task_def_id)
);
```

### 查詢範例

#### 取得測試員的所有任務
```sql
SELECT td.*
FROM task_definitions td
JOIN task_user_assignments tua ON td.id = tua.task_def_id
WHERE tua.user_id = '測試員的UUID'
  AND tua.is_active = true;
```

結果：
```
ID | 標題           | 類型   | 頻率
---|----------------|--------|------
1  | 週四丟垃圾     | 例行   | 每週四
2  | 每月6號匯款    | 例行   | 每月6日
3  | 每日巡檢機台   | 例行   | 每日
4  | 整理316文件    | 交辦   | 單次
```

---

## 🎯 核心邏輯總結

### 分配制度
```
Admin → 在設定頁勾選 → 建立匹配關係 → 儲存到資料庫
                                        ↓
                      使用者登入 → 查詢自己的匹配 → 只顯示被分配的任務
```

### 顯示邏輯
```
使用者登入
  ↓
查詢 task_user_assignments (WHERE user_id = 當前使用者)
  ↓
取得任務列表
  ↓
顯示在行事曆、例行公事、交辦事項
  ↓
加上公共事項（所有人都能看到）
```

---

## ✅ 功能特點

### 1. 個人化顯示
每個人登入只看到屬於自己的任務，不會被其他人的任務干擾。

### 2. 彈性分配
Admin 可以隨時調整任務分配，立即生效。

### 3. 清晰統計
設定頁即時顯示每個人被分配了多少任務。

### 4. 分類管理
任務區分為：
- 例行公事（週期性）
- 交辦事項（一次性）
- 公共事項（所有人）

---

## 🚀 測試步驟

### 1. 進入設定頁
- 以 Admin 登入
- 點擊「設定」分頁

### 2. 分配任務
- 選擇「測試員 (33333)」
- 勾選 4 項任務
- 點擊「儲存變更」

### 3. 切換帳號
- 登出 Admin
- 以「33333」登入
- 查看首頁

### 4. 驗證顯示
- 行事曆應顯示 4 項任務
- 例行公事列表應顯示 3 項
- 交辦事項列表應顯示 1 項

---

**設定頁已完成！立即測試任務分配功能！** 🚀


